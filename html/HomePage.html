<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Work Document Real-Time</title>
    <style>
        body { 
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        
        #chatContainer {
            width: 80%;
            max-width: 800px;
            background: #f8f8f8;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        h2 {
            background: #61baff;
            color: #fff;
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        
        h3 {
            background: #0033fe;
            color: #fff;
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        
        #usernameInputContainer, #toggleContainer, #messageInputContainer {
            padding: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        #chatWrapper {
            display: flex;
            border-bottom: 1px solid #ddd;
        }
        
        #chat, #userlist {
            width: 50%;
            padding: 20px;
            overflow-y: auto;
        }
        
        #chat {
            border-right: 1px solid #ddd;
        }
        
        #chat div, #userlist div {
            margin-bottom: 10px;
        }
        
        #username, #message {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        #setUsername, #send {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background: #ffcc5c;
            color: #fff;
            cursor: pointer;
        }
        
        #setUsername:disabled, #send:disabled {
            background: #ccc;
        }
        
        .timestamp {
            color: #888;
            font-size: 0.9em;
        }
        
        .sender {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="chatContainer">
        <h2>Work Document in Real-Time</h2>
        <div id="usernameInputContainer">
            <input id="username" type="text" placeholder="Enter your username" />
            <button id="setUsername">Set Username</button>
            <button id="simulatePartition">Simulate Partition</button>
            <button id="reconnect" disabled>Reconnect</button>
        </div>
        <div id="toggleContainer">
            <input type="checkbox" id="toggleTimestamps" checked>
            <label for="toggleTimestamps">Show Timestamps</label>
        </div>
        <div id="chatWrapper">
            <div>
                <h3 style="font-size: 12px;">Status</h3>
                <div id="chat"></div>
            </div>
            <div>
                <h3 style="font-size: 12px;">Online Users</h3>
                <div id="userlist"></div>
            </div>
        </div>
        <div id="messageInputContainer">
            <h3 style="font-size: 20px;">Shared Document</h3>
            <textarea id="editor" rows="20" cols="100" placeholder="Content Document..." disabled></textarea>
        </div>
    </div>

    <script>
        const chat = document.getElementById('chat');
        const userlist = document.getElementById('userlist');
        const editor = document.getElementById('editor');
        const usernameInput = document.getElementById('username');
        const setUsernameButton = document.getElementById('setUsername');
        const toggleTimestamps = document.getElementById('toggleTimestamps');
        const simulatePartitionButton = document.getElementById('simulatePartition');
        const reconnectButton = document.getElementById('reconnect');

        let ws;
        let localChanges = [];
        let version = 0;
        let isConnected = true;

        // Create a connection with the server
        function connectedWebSocket() {
            ws = new WebSocket('ws://localhost:4000');
            ws.onopen = () => {
                editor.disabled = false;
                ws.send(JSON.stringify({ type: 'requestUserList' }));

                if (localChanges.length > 0) {
                    localChanges.forEach(change => ws.send(JSON.stringify(change)));
                }
            };

            ws.onmessage = (event) => {
                if (isValidJSON(event.data)) {
                    const data = JSON.parse(event.data);
                    if (data.type === 'content') {
                        reconcileChanges(data.content, data.version);
                    } else if (data.type === 'userList') {
                        updateUserList(data.users);
                    }
                } else {
                    console.log("Received non-JSON message:", event.data);
                }
            };
        }

        // In this method we check if the text is a valid JSON
        function isValidJSON(text) {
            try {
                JSON.parse(text);
                return true;
            } catch {
                return false;
            }
        }

        // In this method we reconcile the changes between the local content and the server content
        function reconcileChanges(newContent, newVersion) {
            console.log('newVersion' + newVersion);
            console.log('version' + version);

            if (isNaN(newVersion)) {
                editor.value = newContent;
            } else if (newVersion > version) {
                console.log('versione maggiore');
                editor.value = newContent;
                version = newVersion;
                localChanges = [];
            } else if (newVersion == version) {
                localChanges.forEach(change => applyChange(change));
            }
        }

        // In this method we apply the changes to the editor
        function applyChange(change) {
            editor.value = change.content;
        }

        // In this method we update the user list
        function updateUserList(users) {
            userlist.innerHTML = users.join("<br>");
        }

        // Toggle the display of timestamps
        toggleTimestamps.onchange = () => {
            const timestamps = document.querySelectorAll('.timestamp');
            timestamps.forEach(timestamp => {
                timestamp.style.display = toggleTimestamps.checked ? 'inline' : 'none';
            });
        };

        // Set the username
        setUsernameButton.onclick = () => {
            const username = usernameInput.value;
            if (username) {
                ws.send(JSON.stringify({ type: 'setUsername', username }));
                usernameInput.disabled = true;
                setUsernameButton.disabled = true;
                editor.disabled = false;
            }
        };

        // Detect changes in the editor
        editor.addEventListener('input', () => {
            if (isConnected) {
                const message = {
                    type: 'update',
                    content: editor.value,
                    version: ++version
                };
                localChanges.push(message);
                ws.send(JSON.stringify(message));
            }
        });

        // Simulate a network partition
        simulatePartitionButton.onclick = () => {
            ws.close();
            isConnected = false;
            reconnectButton.disabled = false;
            simulatePartitionButton.disabled = true;
        };

        // Reconnect to the server
        reconnectButton.onclick = () => {
            connectedWebSocket();
            isConnected = true;
            reconnectButton.disabled = true;
            simulatePartitionButton.disabled = false;
        };

        connectedWebSocket();
    </script>
</body>
</html>
